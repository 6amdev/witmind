# =============================================================================
# Witmind Platform - Docker Compose
# =============================================================================
# All-in-one compose for Witmind platform
# Usage: docker compose up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Reverse Proxy (Caddy)
  # ---------------------------------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Mission Control Backend
  # ---------------------------------------------------------------------------
  mc2-backend:
    build: ../mission-control/backend
    container_name: mc2-backend
    restart: unless-stopped
    environment:
      - MONGODB_URL=mongodb://mongodb:27017/witmind
      - REDIS_URL=redis://redis:6379
      - DEBUG=false
    volumes:
      - ../platform:/app/platform:ro
      - ~/witmind-data/projects:/app/projects:ro
    depends_on:
      - mongodb
      - redis
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Mission Control Frontend
  # ---------------------------------------------------------------------------
  mc2-frontend:
    build: ../mission-control/frontend
    container_name: mc2-frontend
    restart: unless-stopped
    depends_on:
      - mc2-backend
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # MongoDB
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Redis
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Gitea (Git Server)
  # ---------------------------------------------------------------------------
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    restart: unless-stopped
    environment:
      - USER_UID=1000
      - USER_GID=1000
    volumes:
      - gitea_data:/data
    ports:
      - "2222:22"
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Ollama (Local LLM)
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - backend

networks:
  backend:
    name: backend
    external: true

volumes:
  caddy_data:
  caddy_config:
  mongodb_data:
  redis_data:
  gitea_data:
  ollama_data:
