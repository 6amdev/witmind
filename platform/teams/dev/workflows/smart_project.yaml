# Smart Project Workflow
# ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å feature: Flexible Approval, Parallel, Retry, Skip

workflow:
  id: smart_project
  name: "Smart Project Workflow"
  team: dev
  description: "Workflow ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å scenario"

  trigger:
    type: "manual"
    command: "wit new --smart \"description\""

  # ========================================
  # Default Settings
  # ========================================
  defaults:
    approval:
      mode: "auto"                    # Default: auto-approve
      confidence_threshold: 0.8       # ‡∏ñ‡πâ‡∏≤ >= 80% ‚Üí auto approve

    error_handling:
      max_retries: 3                  # ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      retry_delay: 5                  # ‡∏£‡∏≠ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      escalate_after: 3               # ‡∏´‡∏•‡∏±‡∏á 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí escalate

    parallel:
      max_workers: 4                  # ‡∏£‡∏±‡∏ô 4 agents ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

  # ========================================
  # Trust Levels
  # ========================================
  trust_levels:
    development:
      auto_approve: true
      skip_stages: ["spec", "design"]
      require_stages: ["security"]

    staging:
      auto_approve: false
      skip_stages: []
      require_stages: ["testing", "security"]

    production:
      auto_approve: false
      skip_stages: []
      require_stages: ["ALL"]

  # ========================================
  # Stages
  # ========================================
  stages:

    # ----------------------------------------
    # Stage 1: Intake (PM)
    # ----------------------------------------
    - stage: "intake"
      name: "‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"
      agent: pm

      actions:
        - read_request
        - analyze_requirements
        - create_spec

      outputs:
        - "docs/SPEC.md"
        - "PROJECT.yaml"

      approval:
        mode: "auto"
        auto_if:
          - "spec_complete >= 0.9"
          - "requirements_clear"

        confidence:
          threshold: 0.85
          factors:
            spec_complete: 0.4
            requirements_clear: 0.3
            client_info_present: 0.3

      error_handling:
        max_retries: 2
        on_fail: "ask_user_clarification"

      next: "design"

    # ----------------------------------------
    # Stage 2: Design (Tech Lead) - BLOCKING
    # ----------------------------------------
    - stage: "design"
      name: "‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Architecture"
      agent: tech_lead

      inputs:
        - "docs/SPEC.md"

      actions:
        - design_architecture
        - select_tech_stack
        - create_tasks

      outputs:
        - "docs/ARCHITECTURE.md"
        - "docs/TASKS.md"
        - "docs/TECH_STACK.md"

      approval:
        mode: "blocking"            # ‡∏ï‡πâ‡∏≠‡∏á approve ‡πÄ‡∏™‡∏°‡∏≠
        required: true
        description: |
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ review Architecture:
          - Tech stack ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö scale ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

        user_actions:
          - action: "approve"
            next: "development"
          - action: "modify"
            next: "design"
            prompt: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£?"

      next: "development"

    # ----------------------------------------
    # Stage 3: Development (PARALLEL + RETRY)
    # ----------------------------------------
    - stage: "development"
      name: "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö"
      parallel: true

      tasks:
        # Frontend - independent
        - id: "frontend"
          agent: frontend_dev
          task_filter: "frontend/*"
          depends_on: []              # ‡πÑ‡∏°‡πà‡∏£‡∏≠‡πÉ‡∏Ñ‡∏£

          error_handling:
            max_retries: 5            # ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            retry_on:
              - "test_failure"
              - "build_error"
              - "lint_error"
            on_retry:
              - "read_error_message"
              - "identify_cause"
              - "fix_code"
              - "run_tests_again"

        # Backend - independent
        - id: "backend"
          agent: backend_dev
          task_filter: "backend/*"
          depends_on: []

          error_handling:
            max_retries: 5
            retry_on:
              - "test_failure"
              - "build_error"

        # API Integration - waits for backend
        - id: "api_integration"
          agent: fullstack_dev
          task_filter: "integration/*"
          depends_on: ["backend"]     # ‡∏£‡∏≠ backend ‡πÄ‡∏™‡∏£‡πá‡∏à

          error_handling:
            max_retries: 3

        # Frontend Integration - waits for frontend + api
        - id: "frontend_integration"
          agent: frontend_dev
          task_filter: "integration/frontend/*"
          depends_on: ["frontend", "api_integration"]

      # Parallel approval mode
      parallel_approval:
        mode: "batch"               # ‡∏£‡∏ß‡∏° approve ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

      approval:
        mode: "async"               # ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠
        post_review: true           # Review ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á

      # Checkpoint - optional
      checkpoint:
        enabled: true
        on: "each_task_complete"
        message: "{{agent}} ‡πÄ‡∏™‡∏£‡πá‡∏à {{task}} ‡πÅ‡∏•‡πâ‡∏ß"
        actions:
          - "continue"              # ‡∏ó‡∏≥‡∏ï‡πà‡∏≠
          - "review_now"            # Review ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ

      next: "testing"
      timeout_minutes: 180

    # ----------------------------------------
    # Stage 4: Testing (QA) - AUTO
    # ----------------------------------------
    - stage: "testing"
      name: "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö"
      agent: qa_tester

      actions:
        - run_unit_tests
        - run_integration_tests
        - run_e2e_tests
        - generate_coverage_report

      outputs:
        - "tests/**"
        - "docs/TEST_REPORT.md"
        - "coverage/"

      approval:
        mode: "auto"                # Auto-approve ‡∏ñ‡πâ‡∏≤ tests ‡∏ú‡πà‡∏≤‡∏ô
        auto_if:
          - "all_tests_passed"
          - "coverage >= 80"

        confidence:
          threshold: 0.9            # ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à 90%
          factors:
            all_tests_passed: 0.5
            coverage_adequate: 0.3
            no_critical_bugs: 0.2

      error_handling:
        max_retries: 3
        retry_on:
          - "flaky_test"
        no_retry_on:
          - "test_failure"          # ‡∏ñ‡πâ‡∏≤ test fail ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö dev
        on_test_fail: "send_to_development"

      next: "security"

    # ----------------------------------------
    # Stage 5: Security - BLOCKING (REQUIRED)
    # ----------------------------------------
    - stage: "security"
      name: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢"
      agent: security_auditor

      actions:
        - dependency_audit
        - code_security_scan
        - vulnerability_check
        - generate_security_report

      outputs:
        - "docs/SECURITY_REPORT.md"

      approval:
        mode: "blocking"
        required: true
        cannot_skip: true           # ‡∏´‡πâ‡∏≤‡∏° skip ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î

        description: |
          ‚ö†Ô∏è Security Audit ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ approve
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:
          - Critical vulnerabilities
          - Dependency risks
          - Code security issues

        user_actions:
          - action: "approve"
            description: "Security OK"
            next: "deploy_staging"

          - action: "fix_required"
            description: "‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç security issues"
            next: "development"
            prompt: "Issues ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ:"

          - action: "accept_risk"
            description: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö risks ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö"
            next: "deploy_staging"
            prompt: "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö risk:"
            requires_confirmation: true

      next: "deploy_staging"

    # ----------------------------------------
    # Stage 6: Deploy Staging - AUTO
    # ----------------------------------------
    - stage: "deploy_staging"
      name: "Deploy to Staging"
      agent: devops

      actions:
        - build_docker_image
        - deploy_to_staging
        - run_smoke_tests
        - generate_staging_url

      outputs:
        - "Dockerfile"
        - "docker-compose.yml"
        - "docs/DEPLOY_INFO.md"

      approval:
        mode: "auto"                # Auto-approve ‡∏ñ‡πâ‡∏≤ smoke tests ‡∏ú‡πà‡∏≤‡∏ô
        auto_if:
          - "smoke_tests_passed"
          - "staging_healthy"

        confidence:
          threshold: 0.9

      error_handling:
        max_retries: 2
        retry_on:
          - "deploy_failed"
          - "container_crash"
        on_fail: "rollback_and_escalate"

      next: "deploy_production"

    # ----------------------------------------
    # Stage 7: Deploy Production - BLOCKING
    # ----------------------------------------
    - stage: "deploy_production"
      name: "Deploy to Production"
      agent: devops

      approval:
        mode: "blocking"
        required: true
        cannot_skip: true           # ‡∏´‡πâ‡∏≤‡∏° skip

        description: |
          üöÄ Production Deployment
          - Staging URL: {{STAGING_URL}}
          - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏ô staging ‡∏Å‡πà‡∏≠‡∏ô approve

        present_to_user:
          - "docs/DEPLOY_INFO.md"
          - "docs/TEST_REPORT.md"
          - "docs/SECURITY_REPORT.md"

        user_actions:
          - action: "deploy"
            description: "‚úÖ Deploy to Production"
            next: "delivery"

          - action: "staging_only"
            description: "‡πÉ‡∏ä‡πâ Staging ‡∏Å‡πà‡∏≠‡∏ô"
            next: "delivery"
            set_flag: "skip_production"

          - action: "rollback"
            description: "‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
            next: "development"
            prompt: "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:"

      actions:
        - deploy_to_production
        - run_production_healthcheck
        - setup_monitoring

      outputs:
        - "docs/PRODUCTION_INFO.md"

      next: "delivery"

    # ----------------------------------------
    # Stage 8: Delivery - POST_REVIEW
    # ----------------------------------------
    - stage: "delivery"
      name: "‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô"
      agent: pm

      actions:
        - final_documentation
        - create_handoff_notes
        - notify_client

      outputs:
        - "docs/DELIVERY.md"
        - "CHANGELOG.md"

      approval:
        mode: "post_review"         # ‡∏ó‡∏≥‡πÄ‡∏•‡∏¢ review ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
        queue_for_review: true

      on_complete: "move_to_completed"

  # ========================================
  # Error Escalation
  # ========================================
  escalation:
    channels:
      - type: "log"
      - type: "notification"
      - type: "slack"
        webhook: "{{SLACK_WEBHOOK}}"

    on_escalate:
      - notify_human
      - pause_workflow
      - save_state

  # ========================================
  # Notifications
  # ========================================
  notifications:
    on_stage_complete: false        # ‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏∏‡∏Å stage
    on_approval_needed: true        # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á approve
    on_error: true                  # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ error
    on_escalation: true             # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ escalate
    on_complete: true               # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à

  # ========================================
  # State Management
  # ========================================
  state:
    save_checkpoints: true          # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å checkpoint
    allow_resume: true              # Resume ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏õ
    checkpoint_interval: "per_stage"
