# Code Review & Refactor Workflow
# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö review code ‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà

workflow:
  id: code_review
  name: "Code Review & Refactor"
  team: dev
  description: "Review ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"

  trigger:
    type: "manual"
    command: "wit review <path_or_git_url>"

  # Input ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  inputs:
    required:
      - source_path: "path ‡∏´‡∏£‡∏∑‡∏≠ git URL ‡∏Ç‡∏≠‡∏á code ‡πÄ‡∏Å‡πà‡∏≤"
    optional:
      - focus_areas: "‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ focus (performance, security, etc.)"
      - keep_features: "features ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ"
      - change_requests: "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô"

  stages:

    # ========================================
    # Stage 1: Code Analysis
    # ========================================
    - stage: "analysis"
      name: "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤"
      agent: tech_lead

      actions:
        - clone_or_copy_source     # Clone/copy code ‡∏°‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        - analyze_structure        # ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
        - identify_tech_stack      # ‡∏£‡∏∞‡∏ö‡∏∏ tech stack ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
        - document_architecture    # ‡∏ó‡∏≥ document architecture ‡πÄ‡∏î‡∏¥‡∏°
        - identify_issues          # ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö

      outputs:
        - "docs/EXISTING_ANALYSIS.md"    # ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        - "docs/TECH_DEBT.md"            # Technical debt ‡∏ó‡∏µ‡πà‡∏û‡∏ö
        - "docs/CURRENT_ARCHITECTURE.md" # Architecture ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

      next: "security_review"
      timeout_minutes: 60

    # ========================================
    # Stage 2: Security & Quality Review
    # ========================================
    - stage: "security_review"
      name: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security & Quality"
      parallel: true

      tasks:
        - agent: security_auditor
          actions:
            - scan_vulnerabilities
            - check_dependencies
            - review_auth_flow
          outputs:
            - "docs/SECURITY_ISSUES.md"

        - agent: qa_tester
          actions:
            - analyze_test_coverage
            - identify_missing_tests
            - check_code_quality
          outputs:
            - "docs/QUALITY_REPORT.md"

      next: "human_review"
      timeout_minutes: 45

    # ========================================
    # Stage 3: Human Review (Approval Gate)
    # ========================================
    - stage: "human_review"
      name: "üîç Review by Human"
      type: "approval_gate"

      description: |
        ‡∏£‡∏≠‡πÉ‡∏´‡πâ user review analysis results ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ï‡πà‡∏≠:
        - EXISTING_ANALYSIS.md
        - TECH_DEBT.md
        - SECURITY_ISSUES.md
        - QUALITY_REPORT.md

      present_to_user:
        - "docs/EXISTING_ANALYSIS.md"
        - "docs/TECH_DEBT.md"
        - "docs/SECURITY_ISSUES.md"
        - "docs/QUALITY_REPORT.md"

      user_actions:
        - action: "approve"
          description: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô Planning"
          next: "planning"

        - action: "request_more_analysis"
          description: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°"
          next: "analysis"
          prompt_user: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°?"

        - action: "add_requirements"
          description: "‡πÄ‡∏û‡∏¥‡πà‡∏° requirements"
          next: "planning"
          prompt_user: "‡∏°‡∏µ requirements ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?"

        - action: "cancel"
          description: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ"
          next: "cancelled"

    # ========================================
    # Stage 4: Refactor Planning
    # ========================================
    - stage: "planning"
      name: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"
      agent: tech_lead

      inputs:
        - "docs/EXISTING_ANALYSIS.md"
        - "docs/TECH_DEBT.md"
        - "docs/SECURITY_ISSUES.md"
        - "user_feedback"              # ‡∏à‡∏≤‡∏Å human_review

      actions:
        - create_refactor_plan
        - prioritize_changes
        - estimate_effort
        - design_new_architecture

      outputs:
        - "docs/REFACTOR_PLAN.md"      # ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
        - "docs/NEW_ARCHITECTURE.md"   # Architecture ‡πÉ‡∏´‡∏°‡πà
        - "docs/MIGRATION_STEPS.md"    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô migration
        - "docs/TASKS.md"              # Task breakdown

      next: "plan_approval"
      timeout_minutes: 60

    # ========================================
    # Stage 5: Plan Approval (Approval Gate)
    # ========================================
    - stage: "plan_approval"
      name: "üîç Approve Refactor Plan"
      type: "approval_gate"

      description: "‡∏£‡∏≠ user approve ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥"

      present_to_user:
        - "docs/REFACTOR_PLAN.md"
        - "docs/NEW_ARCHITECTURE.md"
        - "docs/TASKS.md"

      user_actions:
        - action: "approve"
          description: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"
          next: "development"

        - action: "modify_plan"
          description: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô"
          next: "planning"
          prompt_user: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£?"

        - action: "approve_partial"
          description: "‡∏ó‡∏≥‡πÅ‡∏Ñ‡πà‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô"
          next: "development"
          prompt_user: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å tasks ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥"

    # ========================================
    # Stage 6: Development
    # ========================================
    - stage: "development"
      name: "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà"
      parallel: true

      tasks:
        - agent: frontend_dev
          condition: "has_frontend_changes"
          task_filter: "frontend/*"

        - agent: backend_dev
          condition: "has_backend_changes"
          task_filter: "backend/*"

        - agent: fullstack_dev
          condition: "is_fullstack"
          task_filter: "fullstack/*"

      next: "testing"
      timeout_minutes: 180

    # ========================================
    # Stage 7: Testing
    # ========================================
    - stage: "testing"
      name: "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö"
      agent: qa_tester

      actions:
        - run_existing_tests
        - run_new_tests
        - compare_with_original
        - generate_report

      outputs:
        - "docs/TEST_REPORT.md"
        - "docs/COMPARISON_REPORT.md"  # ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°

      next:
        pass: "deployment"
        fail: "development"

    # ========================================
    # Stage 8: Deployment
    # ========================================
    - stage: "deployment"
      name: "Deploy ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà"
      agent: devops

      actions:
        - create_migration_script
        - deploy_to_staging
        - run_smoke_tests

      outputs:
        - "docs/DEPLOY_INFO.md"
        - "scripts/migrate.sh"

      next: "delivery"

    # ========================================
    # Stage 9: Delivery
    # ========================================
    - stage: "delivery"
      name: "‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô"
      agent: pm

      actions:
        - create_comparison_summary
        - document_improvements
        - create_delivery_report

      outputs:
        - "docs/DELIVERY.md"
        - "docs/IMPROVEMENTS_SUMMARY.md"

      on_complete: "move_to_completed"

  notifications:
    on_approval_needed: true    # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ approval
    on_stage_complete: true
    on_error: true
    channels:
      - log
      - notification           # ‡∏™‡πà‡∏á notification ‡πÉ‡∏´‡πâ user
