# New Project Workflow with Human Approval Gates
# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ user review ‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

workflow:
  id: new_project_with_approval
  name: "New Project (with Human Checkpoints)"
  team: dev
  description: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏°‡∏µ checkpoints ‡πÉ‡∏´‡πâ user review"

  trigger:
    type: "manual"
    command: "wit new --with-approval \"description\""

  # ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏°‡∏µ approval gates
  approval_mode: true

  stages:

    # ========================================
    # Stage 1: ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
    # ========================================
    - stage: "intake"
      name: "‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"
      agent: pm

      actions:
        - read_request
        - analyze_requirements
        - create_spec

      outputs:
        - "docs/SPEC.md"
        - "PROJECT.yaml"

      next: "spec_approval"
      timeout_minutes: 30

    # ========================================
    # Stage 2: ‚è∏Ô∏è Approval - SPEC
    # ========================================
    - stage: "spec_approval"
      name: "üîç Review SPEC.md"
      type: "approval_gate"

      description: |
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ review SPEC.md ‡∏ó‡∏µ‡πà PM ‡∏™‡∏£‡πâ‡∏≤‡∏á:
        - Requirements ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        - User stories ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        - ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

      present_to_user:
        - "docs/SPEC.md"
        - "PROJECT.yaml"

      user_actions:
        - action: "approve"
          description: "SPEC ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô Design ‡πÑ‡∏î‡πâ"
          next: "design"

        - action: "request_changes"
          description: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SPEC"
          next: "intake"
          prompt_user: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?"

        - action: "add_requirements"
          description: "‡πÄ‡∏û‡∏¥‡πà‡∏° requirements"
          next: "intake"
          prompt_user: "‡∏°‡∏µ requirements ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?"

    # ========================================
    # Stage 3: ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Architecture
    # ========================================
    - stage: "design"
      name: "‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Architecture"
      agent: tech_lead

      inputs:
        - "docs/SPEC.md"
        - "user_feedback"  # feedback ‡∏à‡∏≤‡∏Å approval (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

      actions:
        - design_architecture
        - select_tech_stack
        - create_tasks

      outputs:
        - "docs/ARCHITECTURE.md"
        - "docs/TASKS.md"
        - "docs/TECH_STACK.md"

      next: "design_approval"
      timeout_minutes: 45

    # ========================================
    # Stage 4: ‚è∏Ô∏è Approval - Design
    # ========================================
    - stage: "design_approval"
      name: "üîç Review Architecture"
      type: "approval_gate"

      description: |
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ review Architecture ‡∏ó‡∏µ‡πà Tech Lead ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö:
        - Tech stack ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        - Architecture ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö requirements ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        - ‡∏°‡∏µ concerns ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á

      present_to_user:
        - "docs/ARCHITECTURE.md"
        - "docs/TECH_STACK.md"
        - "docs/TASKS.md"

      user_actions:
        - action: "approve"
          description: "Design ‡∏î‡∏µ ‡πÄ‡∏£‡∏¥‡πà‡∏° Development ‡πÑ‡∏î‡πâ"
          next: "development"

        - action: "modify_design"
          description: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Design"
          next: "design"
          prompt_user: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£?"

        - action: "change_tech_stack"
          description: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Tech Stack"
          next: "design"
          prompt_user: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ tech ‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏ó‡∏ô?"

    # ========================================
    # Stage 5: ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
    # ========================================
    - stage: "development"
      name: "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö"
      parallel: true

      tasks:
        - agent: frontend_dev
          condition: "has_frontend"
          task_filter: "frontend/*"

        - agent: backend_dev
          condition: "has_backend"
          task_filter: "backend/*"

        - agent: fullstack_dev
          condition: "is_fullstack"
          task_filter: "fullstack/*"

      # Optional: checkpoint ‡∏´‡∏•‡∏±‡∏á development
      checkpoint:
        enabled: true
        on: "task_complete"
        message: "Feature {{task_name}} ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ review ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"
        actions:
          - review_now
          - continue

      next: "testing"
      timeout_minutes: 120

    # ========================================
    # Stage 6: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
    # ========================================
    - stage: "testing"
      name: "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö"
      agent: qa_tester

      actions:
        - run_unit_tests
        - run_integration_tests
        - run_e2e_tests
        - generate_report

      outputs:
        - "tests/**"
        - "docs/TEST_REPORT.md"

      next: "test_approval"
      timeout_minutes: 45

    # ========================================
    # Stage 7: ‚è∏Ô∏è Approval - Test Results
    # ========================================
    - stage: "test_approval"
      name: "üîç Review Test Results"
      type: "approval_gate"

      description: |
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ review ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
        - Test coverage ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        - ‡∏°‡∏µ bugs ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô deploy ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

      present_to_user:
        - "docs/TEST_REPORT.md"

      user_actions:
        - action: "approve"
          description: "Tests ‡∏ú‡πà‡∏≤‡∏ô ‡πÑ‡∏õ Security Audit"
          next: "security"

        - action: "fix_bugs"
          description: "‡∏°‡∏µ bugs ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ"
          next: "development"
          prompt_user: "bugs ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ:"

        - action: "add_tests"
          description: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ tests ‡πÄ‡∏û‡∏¥‡πà‡∏°"
          next: "testing"
          prompt_user: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ test ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°?"

    # ========================================
    # Stage 8: Security Audit
    # ========================================
    - stage: "security"
      name: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢"
      agent: security_auditor

      actions:
        - code_review
        - dependency_audit
        - vulnerability_scan

      outputs:
        - "docs/SECURITY_REPORT.md"

      next: "security_approval"
      timeout_minutes: 30

    # ========================================
    # Stage 9: ‚è∏Ô∏è Approval - Security
    # ========================================
    - stage: "security_approval"
      name: "üîç Review Security Report"
      type: "approval_gate"

      description: |
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ review Security Report:
        - ‡∏°‡∏µ vulnerabilities ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô deploy ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        - ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö risks ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

      present_to_user:
        - "docs/SECURITY_REPORT.md"

      user_actions:
        - action: "approve"
          description: "Security OK, ‡πÑ‡∏õ Deploy"
          next: "deployment"

        - action: "fix_security"
          description: "‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ security issues ‡∏Å‡πà‡∏≠‡∏ô"
          next: "development"
          prompt_user: "issues ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ:"

        - action: "accept_risk"
          description: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö risks, ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ"
          next: "deployment"
          prompt_user: "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö risk:"

    # ========================================
    # Stage 10: Deployment
    # ========================================
    - stage: "deployment"
      name: "Deploy ‡∏£‡∏∞‡∏ö‡∏ö"
      agent: devops

      actions:
        - create_dockerfile
        - build_image
        - deploy_staging
        - run_smoke_tests

      outputs:
        - "Dockerfile"
        - "docker-compose.yml"
        - "docs/DEPLOY_INFO.md"

      next: "deploy_approval"
      timeout_minutes: 30

    # ========================================
    # Stage 11: ‚è∏Ô∏è Approval - Deploy to Production
    # ========================================
    - stage: "deploy_approval"
      name: "üîç Approve Production Deploy"
      type: "approval_gate"

      description: |
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏° deploy production:
        - Staging URL: {{STAGING_URL}}
        - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏ô staging ‡∏Å‡πà‡∏≠‡∏ô approve

      present_to_user:
        - "docs/DEPLOY_INFO.md"
        - "docs/TEST_REPORT.md"
        - "docs/SECURITY_REPORT.md"

      user_actions:
        - action: "deploy_production"
          description: "‚úÖ Deploy to Production"
          next: "delivery"

        - action: "staging_only"
          description: "‡πÉ‡∏ä‡πâ Staging ‡∏Å‡πà‡∏≠‡∏ô, ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà deploy production"
          next: "delivery"

        - action: "rollback"
          description: "‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤, ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
          next: "development"
          prompt_user: "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:"

    # ========================================
    # Stage 12: ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
    # ========================================
    - stage: "delivery"
      name: "‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô"
      agent: pm

      actions:
        - final_review
        - create_delivery_report
        - notify_client

      outputs:
        - "docs/DELIVERY.md"

      on_complete: "move_to_completed"

  notifications:
    on_approval_needed: true
    on_stage_complete: false
    on_error: true
    channels:
      - log
      - notification
